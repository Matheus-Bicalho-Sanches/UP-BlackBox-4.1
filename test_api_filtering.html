<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Filtro API Motion Tracker</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #1a1a1a; color: white; }
        .container { max-width: 1000px; margin: 0 auto; }
        .card { background: #2a2a2a; border: 1px solid #444; border-radius: 8px; padding: 20px; margin: 20px 0; }
        .button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin: 5px; }
        .button:hover { background: #0056b3; }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .warning { color: #ffc107; }
        pre { background: #333; padding: 10px; border-radius: 4px; overflow-x: auto; max-height: 400px; }
        .symbol-select { padding: 8px; margin: 10px; border-radius: 4px; background: #444; color: white; border: 1px solid #666; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Teste de Filtro por S√≠mbolo - Motion Tracker API</h1>
        
        <div class="card">
            <h3>üîç Teste de Filtro por S√≠mbolo</h3>
            <label for="symbolSelect">Selecionar S√≠mbolo:</label>
            <select id="symbolSelect" class="symbol-select">
                <option value="TODOS">TODOS</option>
                <option value="PETR4">PETR4</option>
                <option value="VALE3">VALE3</option>
                <option value="TIMS3">TIMS3</option>
                <option value="ABEV3">ABEV3</option>
            </select>
            <button class="button" onclick="testPatterns()">Testar Padr√µes</button>
            <button class="button" onclick="testActivity()">Testar Atividade</button>
            <div id="filterResults"></div>
        </div>

        <div class="card">
            <h3>üìä Compara√ß√£o: TODOS vs S√≠mbolo Espec√≠fico</h3>
            <button class="button" onclick="compareResults()">Comparar Resultados</button>
            <div id="comparisonResults"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8002';

        async function makeRequest(url, description) {
            try {
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.success) {
                    return { success: true, data, description };
                } else {
                    return { success: false, error: data.message || 'Erro desconhecido', description };
                }
            } catch (error) {
                return { success: false, error: error.message, description };
            }
        }

        function displayResult(elementId, result) {
            const element = document.getElementById(elementId);
            
            if (result.success) {
                element.innerHTML = `
                    <div class="success">‚úÖ ${result.description}</div>
                    <div class="warning">üìä Total de itens: ${result.data.patterns ? result.data.patterns.length : result.data.trades ? result.data.trades.length : 'N/A'}</div>
                    <pre>${JSON.stringify(result.data, null, 2)}</pre>
                `;
            } else {
                element.innerHTML = `
                    <div class="error">‚ùå ${result.description}: ${result.error}</div>
                `;
            }
        }

        async function testPatterns() {
            const symbol = document.getElementById('symbolSelect').value;
            const url = symbol === 'TODOS' ? `${API_BASE}/robots/patterns` : `${API_BASE}/robots/patterns?symbol=${symbol}`;
            const description = symbol === 'TODOS' ? 'Todos os padr√µes' : `Padr√µes para ${symbol}`;
            
            const result = await makeRequest(url, description);
            displayResult('filterResults', result);
        }

        async function testActivity() {
            const symbol = document.getElementById('symbolSelect').value;
            const url = symbol === 'TODOS' ? `${API_BASE}/robots/activity?hours=24` : `${API_BASE}/robots/activity?symbol=${symbol}&hours=24`;
            const description = symbol === 'TODOS' ? 'Toda atividade' : `Atividade para ${symbol}`;
            
            const result = await makeRequest(url, description);
            displayResult('filterResults', result);
        }

        async function compareResults() {
            const symbol = document.getElementById('symbolSelect').value;
            if (symbol === 'TODOS') {
                alert('Selecione um s√≠mbolo espec√≠fico para comparar');
                return;
            }

            const element = document.getElementById('comparisonResults');
            element.innerHTML = '<div class="warning">üîÑ Comparando resultados...</div>';

            try {
                // Busca todos os padr√µes
                const allPatterns = await makeRequest(`${API_BASE}/robots/patterns`, 'Todos os padr√µes');
                
                // Busca padr√µes do s√≠mbolo espec√≠fico
                const symbolPatterns = await makeRequest(`${API_BASE}/robots/patterns?symbol=${symbol}`, `Padr√µes para ${symbol}`);

                if (allPatterns.success && symbolPatterns.success) {
                    const allCount = allPatterns.data.patterns ? allPatterns.data.patterns.length : 0;
                    const symbolCount = symbolPatterns.data.patterns ? symbolPatterns.data.patterns.length : 0;
                    
                    // Filtra manualmente para verificar
                    const manualFiltered = allPatterns.data.patterns ? 
                        allPatterns.data.patterns.filter(p => p.symbol === symbol) : [];
                    
                    element.innerHTML = `
                        <div class="success">üìä Compara√ß√£o Conclu√≠da</div>
                        <div class="warning">
                            <strong>Resultados:</strong><br>
                            ‚Ä¢ Todos os padr√µes: ${allCount}<br>
                            ‚Ä¢ Padr√µes para ${symbol}: ${symbolCount}<br>
                            ‚Ä¢ Filtro manual: ${manualFiltered.length}<br>
                        </div>
                        <div class="warning">
                            <strong>Verifica√ß√£o:</strong><br>
                            ‚Ä¢ API filtrou corretamente: ${symbolCount === manualFiltered.length ? '‚úÖ SIM' : '‚ùå N√ÉO'}<br>
                            ‚Ä¢ S√≠mbolos √∫nicos em "todos": ${allPatterns.data.patterns ? [...new Set(allPatterns.data.patterns.map(p => p.symbol))].join(', ') : 'N/A'}<br>
                        </div>
                        <details>
                            <summary>üîç Detalhes dos Padr√µes para ${symbol}</summary>
                            <pre>${JSON.stringify(symbolPatterns.data, null, 2)}</pre>
                        </details>
                    `;
                } else {
                    element.innerHTML = `
                        <div class="error">‚ùå Erro na compara√ß√£o</div>
                        <div>All: ${allPatterns.success ? '‚úÖ' : '‚ùå'}</div>
                        <div>Symbol: ${symbolPatterns.success ? '‚úÖ' : '‚ùå'}</div>
                    `;
                }
            } catch (error) {
                element.innerHTML = `<div class="error">‚ùå Erro na compara√ß√£o: ${error.message}</div>`;
            }
        }

        // Teste autom√°tico ao carregar
        window.onload = function() {
            testPatterns();
        };
    </script>
</body>
</html>
